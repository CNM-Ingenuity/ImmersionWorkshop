<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Part 2 - Blockchain Immersion Workshop</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Part 2";
    var mkdocs_page_input_path = "vscode-part2.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Blockchain Immersion Workshop</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Hyperledger Fabric Lab</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../hlf-home/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../hlf-part1/">Part 1</a>
                </li>
                <li class="">
                    
    <a class="" href="../hlf-part2/">Part 2</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Use Case Walkthrough</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../immunichain-home/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../immunichain/">Part 1</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">VSCode Lab</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../vscode-home/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../vscode-part1/">Part 1</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Part 2</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#part-2-commercial-paper-tutorial">Part 2: Commercial Paper Tutorial</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#section-1-overview">Section 1: Overview</a></li>
        
            <li><a class="toctree-l4" href="#section-2-setting-the-stage">Section 2: Setting the Stage</a></li>
        
            <li><a class="toctree-l4" href="#section-3-install-and-instantiate-smart-contract">Section 3: Install and Instantiate Smart Contract</a></li>
        
            <li><a class="toctree-l4" href="#section-4-issue-identities">Section 4: Issue Identities</a></li>
        
            <li><a class="toctree-l4" href="#section-5-upgrade-smart-contract">Section 5: Upgrade Smart Contract</a></li>
        
            <li><a class="toctree-l4" href="#section-6-submit-transactions">Section 6: Submit Transactions</a></li>
        
            <li><a class="toctree-l4" href="#section-7-lab-cleanup">Section 7: Lab Cleanup</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">IBM Blockchain Platform Connect-a-thon Lab</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../connect-home/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../connect-part1/">Part 1</a>
                </li>
                <li class="">
                    
    <a class="" href="../connect-part2/">Part 2</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../references/">Additional Resources</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Blockchain Immersion Workshop</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>VSCode Lab &raquo;</li>
        
      
    
    <li>Part 2</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="part-2-commercial-paper-tutorial">Part 2: Commercial Paper Tutorial</h1>
<h2 id="section-1-overview">Section 1: Overview</h2>
<p>This tutorial works with a sample commercial paper trading
network called <code>PaperNet</code>. Commercial paper is a type of unsecured lending in the
form of a "promissory note". The papers are normally issued by large
corporations to raise funds to meet short-term financial obligations at
a fixed rate of interest. Once issued at a fixed price, for a fixed
term, another company or bank will purchase them at a discount to the
face value and when the term is up, they will be redeemed for their face
value.</p>
<p>As an example, if a paper was issued at a face value of 10M USD for a
6-month term at 2% interest then it could be bought for 9.8M USD (10M --
2%) by another company or bank who are happy to bear the risk that the
issuer will not default. Once the term is up, then the paper could be
redeemed or sold back to the issuer for its full face value of 10M
USD. Between buying and redemption, the paper can be bought or sold
between different parties on a commercial paper market.</p>
<p>These three key steps of issue, buy and redeem are the main transactions
in a simplified commercial paper marketplace, which we will mirror in
our lab. We will see a commercial paper issued by a company called
MagnetoCorp and, once issued on the commercial paper blockchain network,
another company called DigiBank will first buy the paper and then redeem
it.</p>
<p>You'll act as a developer, end user, and administrator, within
different organizations, performing various steps designed to help
you understand what it's like to collaborate as two different
organizations working independently, but according to mutually agreed
rules in a Hyperledger Fabric network.</p>
<p>Below is an image of our PaperNet network. For our lab, we will create
Isabella who is with MagnetoCorp. Additionally, we will create Balaji
who is with DigiBank. Isabella will issue a paper for the network. The
paper will have an ID number, when it was issued, the maturity date, and
the face value ($). Balaji, from DigiBank, will then buy the paper and
then eventually redeem it.</p>
<p><img alt="image" src="../images/papernet_overview.png" /></p>
<p>Below is the full breakdown of Part 2 of this lab:</p>
<ul>
<li>
<p>Setting the Stage:</p>
<ul>
<li>Based off of Part 1, we have started a blockchain network,
        created a smart contract, created and run tests and then
        submitted transactions. For Part 2, we need to create a
        couple more docker containers that will set us up for
        success for the rest of the lab. One of these containers
        will just monitor the docker network we are operating in. If
        you have no idea what a docker network is, I will explain
        later on. The other container contains Hyperledger Fabric 
    tools and is named <code>cliMagnetoCorp</code>, as MagnetoCorp will
    use the Hyperledger Fabric command line interface (cli)
    within this container.</li>
</ul>
</li>
<li>
<p>Install and Instantiate Smart Contract:</p>
<ul>
<li>Now that we have those new docker containers up and running,
        we will enter our <code>cliMagnetoCorp</code> container and install and
        instantiate our smart contract. Since we are connected to
        the same running local Hyperledger Fabric network, we will
        see the smart contract show up in VSCode.</li>
</ul>
</li>
<li>
<p>Issue Identities:</p>
<ul>
<li>In this section, we will issue two identites. One is an
        end-user named <code>Isabella</code> with <code>MagnetoCorp</code>. She will
        invoke a transaction that will issue a paper. Then we will
        issue an identity for <code>DigiBank</code> named <code>Balaji</code>. Balaji will
        act as the adminstrator for Digibank and will buy and redeem
        the paper that Isabella issued. Balaji is important in this
        lab, as we will add a <code>Fabric Gateway</code> connection to connect
        to his perspective of the network.</li>
</ul>
</li>
<li>
<p>Upgrade Smart Contract:</p>
<ul>
<li>This section is the longest of the entire lab, but it really
        exemplifies the power of VSCode and the IBM Blockchain
        Platform extension. We will update our smart contract code
        to include one more transaction called <code>getPaper</code>. This
        transaction will allow us to see the current status of the
        paper, like who knows it, what is its status and how much is
        it worth. In addition to modifiying the code, we will update
        our smart contract so that the network is aware of the new
        smart contract.</li>
</ul>
</li>
<li>
<p>Submit Transactions:</p>
<ul>
<li>Now that we have added a transaction to our smart contract,
        we will then submit various transactions from many different
        places and perspectives. For example, we will issue a
        transaction from the command line interface as well as the
        VSCode user interface. We will also issue another paper from
        Isabella's perspective and then invoke a series of
        transactions from Balaji's perspective to buy and redeem the paper.</li>
</ul>
</li>
<li>
<p>Lab Cleanup:</p>
<ul>
<li>This is the most bittersweet part of the entire lab. It
        means the lab is over and we have to clean up. If you have
        kids (I don't), I'd imagine their faces are sad and full
        of despair when you (the guardian) tell them to clean up
        their mess. I'd also like to imagine your face is making a
        similar expression right now. It's okay, more fun is going
        to be had soon - very soon!</li>
</ul>
</li>
</ul>
<h2 id="section-2-setting-the-stage">Section 2: Setting the Stage</h2>
<p><strong>NOTE:</strong> There are two terminals we can operate in - the actual
terminal application, available on your Ubuntu desktop, and the terminal window available in VSCode. Unless I
explicitly say, only use the terminal application - meaning do <strong>not</strong>
use the terminal in VSCode. On the chance that we will use the terminal
in VSCode, I will specify that.</p>
<p><strong>1.</strong> Open your terminal and navigate to your Desktop directory and then clone
the <code>fabric-samples</code> github repository</p>
<pre><code>tecadmin@ubuntubase:~$ cd Desktop/
tecadmin@ubuntubase:~/Desktop$ ls -l
total 0
drwxr-xr-x  16 tecadmin  tecadmin  512 Feb 22 12:34 mycontract
tecadmin@ubuntubase:~/Desktop$ git clone https://github.com/hyperledger/fabric-samples.git
Cloning into 'fabric-samples'...
remote: Enumerating objects: 85, done.
remote: Counting objects: 100% (85/85), done.
remote: Compressing objects: 100% (71/71), done.
remote: Total 2658 (delta 26), reused 71 (delta 13), pack-reused 2573
Receiving objects: 100% (2658/2658), 927.08 KiB | 0 bytes/s, done.
Resolving deltas: 100% (1293/1293), done.
tecadmin@ubuntubase:~/Desktop$ ls -l
total 0
drwxr-xr-x  22 tecadmin  tecadmin  704 Feb 22 12:41 fabric-samples
drwxr-xr-x  16 tecadmin  tecadmin  512 Feb 22 12:34 mycontract
</code></pre>
<p><strong>2.</strong> We need to know the Docker network that we are currently in so
that we can modify some scripts that will then create more Docker
containers for us to use. Enter the command below to see all of our
Docker networks</p>
<pre><code>tecadmin@ubuntubase:~/Desktop$ docker network list
NETWORK ID          NAME                            DRIVER              SCOPE
ad2e1a3e2fc2        bridge                          bridge              local
35837170ae5b        fabricvscodelocalfabric_basic   bridge              local
c5e0411b0d34        host                            host                local
42ffa501f2f9        none                            null                local
</code></pre>
<p><strong>3.</strong> The network we are in is called <code>fabricvscodelocalfabric_basic</code>
and we can verify that by doing the following command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop$ docker network inspect fabricvscodelocalfabric_basic
</code></pre>
<p>That command will show you all the containers running in this network.
In a nutshell, docker networks are natural ways to isolate containers
from other containers or other networks. Having containers within a
network allows them to communicate with other containers in
the network.</p>
<p><strong>4.</strong> Within VSCode, go to the <code>Explorer</code> perspective and click on <code>File</code>
and select <code>Add Folder to Workplace..</code> - This will allow us to work from
an <code>Untitled Workplace</code>, but have the <code>fabric-samples</code> folder in there.</p>
<p><strong>5.</strong> Within VSCode, navigate to the folder below within MagnetoCorp </p>
<pre><code>fabric-samples -&gt; commercial paper -&gt; organizations -&gt; magenetocorp -&gt; configuration -&gt; cli
</code></pre>
<p>You should see two files in there. One named <code>docker-compose.yml</code> and
another named <code>monitordocker.sh</code></p>
<p><img alt="image" src="../images/13.png" /></p>
<p><strong>6.</strong> Within the <code>docker-compose.yml</code> file, replace the <code>net_basic</code>
with <code>fabricvscodelocalfabric_basic</code> on line 11 and save your file by
pressing <code>control + s</code></p>
<p><strong>7.</strong> Now within the <code>monitordocker.sh</code> file, replace
<code>basicnetwork_basic</code> with <code>fabricvscodelocalfabric_basic</code> on line 9 and
again save by pressing <code>control + s</code></p>
<p><strong>8.</strong> Now from the terminal navigate to the cli directory within
MagnetoCorp. <strong>NOTE:</strong> scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop$ cd fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ ls -l
total 16
-rw-r--r--  1 tecadmin  tecadmin  1168 Feb 22 12:41 docker-compose.yml
-rwxr-xr-x  1 tecadmin  tecadmin   751 Feb 22 12:44 monitordocker.sh
</code></pre>
<p><strong>9.</strong> Now that we have updated these files to specify the correct
Docker network, go ahead run the monitordocker.sh script with the name of our
Docker network. <strong>NOTE:</strong> scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ ./monitordocker.sh fabricvscodelocalfabric_basic
</code></pre>
<p>This command will pull down another container that just monitors all of
the docker log output from the <code>fabricvscodelocalfabric_basic</code> network.
I'm going off a hunch, but I think that's why the file is called
<code>monitordocker.sh</code>. We will see more messages coming very soon.</p>
<p><strong>10.</strong> Since this terminal is occupied with log messages, let's open
another terminal tab. We can open a new tab by clicking on <code>File</code> and
then selecting <code>New Tab</code></p>
<p><strong>11.</strong> When you opened a new tab, you should have been taken to the
same file path that you were in on the previous tab. Now that we have a
command line ready, go ahead and enter the command below that will
create a <code>cliMagnetoCorp</code> container for our docker network to use.
<strong>NOTE:</strong> scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ docker-compose -f docker-compose.yml up -d cliMagnetoCorp
.
. # We'll see docker messages
.
Status: Downloaded newer image for hyperledger/fabric-tools:latest
Creating cliMagnetoCorp ... 
Creating cliMagnetoCorp ... done
</code></pre>
<p>When we first install the smart contract, we will go through the
<code>cliMagnetoCorp</code> container, which is our Administrator Console. This
will allow us to use Fabric <code>peer</code> commands. Conveniently, the
<code>cliMagnetoCorp</code> container is the <code>hyperledger/fabric-tools</code> image.</p>
<p><img alt="image" src="../images/papernet_magnetocorp.png" /></p>
<p><strong>12.</strong> We can also do a <code>docker ps -a</code> command to see all of our docker
containers. We should see two new containers - <code>cliMagnetoCorp</code> and
<code>logspout</code></p>
<p><strong>13.</strong> Equally, we could do
<code>docker network inspect fabricvscodelocalfabric_basic</code> to see all of our
containers together in one network - and no, not in a blockchain
network. They are, however, the components that make up our local
blockchain network :)</p>
<h2 id="section-3-install-and-instantiate-smart-contract">Section 3: Install and Instantiate Smart Contract</h2>
<p>Before we actually install the commercial paper smart contract, let's
actually open the file to see what the smart contract is trying to do.</p>
<p><strong>1.</strong> From your explorer perspective, navigate from the fabric-samples
folder to the contract folder of <code>MagnetoCorp</code> </p>
<pre><code>fabric-samples -&gt; commercial-paper -&gt; organization -&gt; magnetocorp -&gt; contract
</code></pre>
<p>Within the <code>lib</code> folder, you'll see 3 javascript (.js) files in there.
Click on the <strong>papercontract.js</strong> file, which will open it 
within VSCode</p>
<p><img alt="image" src="../images/14.png" /></p>
<p>Let's dissect our <code>papercontract.js</code> file as it is our smart contract.
We will only go over the <code>issue</code> transaction, but the other transactions
follow pretty closely to this one</p>
<p>Below, these 2 lines of code bring into scope two key Hyperledger
Fabric classes that will be used extensively by the smart contract --
Contract and Context </p>
<pre><code>// Fabric smart contract classes
const { Contract, Context } = require('fabric-contract-api');
</code></pre>
<p>Below, we define the smart contract class CommercialPaperContract based
on the built-in Fabric Contract class. The methods which implement the
key transactions to issue, buy and redeem commercial paper are defined
within this class </p>
<pre><code>/**
* Define commercial paper smart contract by extending Fabric Contract class
*
*/
class CommercialPaperContract extends Contract {
</code></pre>
<p>Below, this method defines the commercial paper <code>issue</code> transaction for
the commercial paper blockchain network. The parameters that are passed to
this method will be used to create the new commercial paper. Locate and
examine the <code>buy</code> and <code>redeem</code> transactions within the smart contract </p>
<pre><code>/**
* Issue commercial paper
*
* @param {Context} ctx the transaction context
* @param {String} issuer commercial paper issuer
* @param {Integer} paperNumber paper number for this issuer
* @param {String} issueDateTime paper issue date
* @param {String} maturityDateTime paper maturity date
* @param {Integer} faceValue face value of paper
*/
async issue(ctx, issuer, paperNumber, issueDateTime, maturityDateTime, faceValue) {
</code></pre>
<p>Within the issue transaction, this statement creates a new commercial
paper in memory using the CommercialPaper class with the supplied
transaction inputs. Examine the buy and redeem transactions to see how
they similarly use this class </p>
<pre><code>// create an instance of the paper
let paper = CommercialPaper.createInstance(issuer, paperNumber, issueDateTime, maturityDateTime, faceValue);
</code></pre>
<p>Below, this statement adds the new commercial paper to the ledger using
ctx.paperList, an instance of a PaperList class that was created when
the smart contract context CommercialPaperContext was initialized.
Again, examine the buy and redeem methods to see how they use this class</p>
<pre><code>// Add the paper to the list of all similar commercial papers in the ledger world state
await ctx.paperList.addPaper(paper);
</code></pre>
<p>Below you will find that this statement returns a binary buffer as
response from the issue transaction for processing by the caller of the
smart contract</p>
<pre><code>// Must return a serialized paper to caller of smart contract
return paper.toBuffer();
</code></pre>
<p><strong>2.</strong> Now that we have an understanding of the smart contract, let's
actually install it on our peer through our terminal. <strong>NOTE:</strong> scroll
over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ docker exec cliMagnetoCorp peer chaincode install -n papercontract -v 0 -p /opt/gopath/src/github.com/contract -l node
2019-02-22 17:48:23.721 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 001 Using default escc
2019-02-22 17:48:23.721 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 002 Using default vscc
2019-02-22 17:48:23.862 UTC [chaincodeCmd] install -&gt; INFO 003 Installed remotely response:&lt;status:200 payload:"OK" &gt;
</code></pre>
<p>A message saying <code>200</code> is a great sign to see.</p>
<p>If you notice, we are not in the contract folder of our command line
interface. Instead, we are entering the <code>cliMagnetoCorp</code> docker
container with <code>docker exec cliMagnetoCorp</code> and navigating to the
<code>/opt/gopath/src/github.com/contract</code> file path within our container to
grab the files we need to install the smart contract. The
<code>-n papercontract</code> flag names our smart contract <code>papercontract</code>. The
<code>-v 0</code> gives our smart contract a version of 0. Finally, the <code>-l node</code>
tells us that the language of our smart contract is nodejs. The picture
below goes into detail, visually, as to how we are actually installing a
copy of the commercial paper smart contract on our peer.</p>
<p><img alt="image" src="../images/papernet_magnetoinstall.png" /></p>
<p><strong>3.</strong> Since our network is connected to our VSCode instance, you can
refresh the <code>Local Fabric Ops</code> panel in VSCode under the IBM Blockchain
extension. The refresh button is revealed when you hover your mouse over
the <code>Local Fabric Ops</code> panel</p>
<p><img alt="image" src="../images/15.png" /></p>
<p><strong>4.</strong> Since we have installed the smart contract, we should actually
make it active by instantiating it. <strong>NOTE:</strong> scroll over to see the
entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ docker exec cliMagnetoCorp peer chaincode instantiate -n papercontract -v 0 -l node -c '{"Args":["org.papernet.commercialpaper:instantiate"]}' -C mychannel -P ""
2019-02-22 17:50:34.673 UTC [chaincodeCmd] InitCmdFactory -&gt; INFO 001 Retrieved channel (mychannel) orderer endpoint:   orderer.example.com:7050
2019-02-22 17:50:34.675 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 002 Using default escc
2019-02-22 17:50:34.675 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default vscc
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$
</code></pre>
<p>As you can see in the image below, we are instantiating a copy of the
commercial paper smart contract on our MagnetoCorp peer. Similar to the
installation of the smart contract, the instantiation goes into the
<code>cliMagnetoCorp</code> container. After successfully instantiating the smart
contract, there will be a commercial paper smart contract docker image
and container.</p>
<p><img alt="image" src="../images/papernet_magnetoinstant.png" /></p>
<p><strong>5.</strong> You will know our instantiate command worked when we get
our command prompt back without any error messages. You can really verify it worked by going back
to the VSCode and refreshing the <code>Local Fabric Ops</code> panel and you should
see it under the <code>instantiate</code> section.</p>
<p><img alt="image" src="../images/16.png" /></p>
<h2 id="section-4-issue-identities">Section 4: Issue Identities</h2>
<p>Now that we have a ready-to-use smart contract, let's issue some
identities so that those identities can invoke and query transactions.</p>
<p><strong>1.</strong> You should be within the <code>cli</code> folder of the MagnetoCorp folder.
You can confirm this by issuing the command below. <strong>NOTE:</strong> scroll over
to see the entire command below</p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ pwd
/Users/home/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli
</code></pre>
<p>This is a good sign. Issue the following command below to get to the
<code>application</code> folder within MagnetoCorp. <strong>NOTE:</strong> scroll over to see
the entire command below</p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/configuration/cli/$ cd ../../application/
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$
</code></pre>
<p><strong>2.</strong> From the <code>Explorer</code> perspective within VSCode, navigate to the
same folder. That is, the <code>application</code> folder within <code>MagnetoCorp</code>. You
should see 4 files in there: <code>.eslintrc.js, addToWallet.js, issue.js</code>,
and <code>package.json</code></p>
<p><img alt="image" src="../images/17.png" /></p>
<p><strong>3.</strong> Click on <code>issue.js</code>, which will open the file within VSCode.
Let's discuss what the file is trying to do.</p>
<p>Below we bring two key Hyperledger Fabric SDK classes into scope --
<code>Wallet</code> and <code>Gateway</code>. Because Isabella's X.509 certificate is in the
local file system, the application uses <code>FileSystemWallet</code> </p>
<pre><code>// Bring key classes into scope, most importantly Fabric SDK network class 
const { FileSystemWallet, Gateway } = require('fabric-network');
</code></pre>
<p>Below, this statement identifies that the application will use
Isabella's wallet when it connects to the blockchain network channel.
The application will select a particular identity within Isabella's
wallet. (The wallet must have been loaded with Isabella's X.509
certificate -- that's what <code>addToWallet.js</code> does.)</p>
<pre><code>// A wallet stores a collection of identities for use 
const wallet = new FileSystemWallet('../identity/user/isabella/wallet');
</code></pre>
<p>This line of code, below, connects to the network using the gateway
identified by <code>connectionProfile</code>, using the identity referred to in
<code>ConnectionOptions</code>. See how <code>../gateway/networkConnection.yaml</code> and
<code>User1@org1.example.com</code> are used for these values respectively</p>
<pre><code>// Connect to gateway using application specified parameters 
await gateway.connect(connectionProfile, connectionOptions);
</code></pre>
<p>Below in the couple lines of code, the application connects to the
network channel <code>mychannel</code>, where the papercontract was previously
instantiated. If you had a different channel name, you would have to
modify this line of code </p>
<pre><code>// Access commercial paper network 
const network = await gateway.getNetwork('mychannel');
</code></pre>
<p>Below, this statement gives the application addressability to the smart
contract defined by the namespace org.papernet.commercialpaper within
papercontract. Once an application has issued getContract, it can submit
any transaction implemented within it </p>
<pre><code>// Get addressability to commercial paper contract 
const contract = await network.getContract('papercontract', 'org.papernet.comm...');
</code></pre>
<p>Below, these lines of code submit a transaction to the network using
the <code>issue</code> transaction defined within the smart contract.
<code>MagnetoCorp, 00001</code> are the values to be used by the issue transaction
to create a new commercial paper </p>
<pre><code>// issue commercial paper 
const issueResponse = await contract.submitTransaction('issue','MagnetoCorp', '00001', '2020-05-31', '2020-11-30','5000000');
</code></pre>
<p>This statement, below, processes the response from the <code>issue</code>
transaction. The response needs to be deserialized from a buffer into
paper, a CommercialPaper object which can be interpreted correctly by
the application </p>
<pre><code>// process response let paper =
CommercialPaper.fromBuffer(issueResponse);
</code></pre>
<p><strong>4.</strong> Since we know our <code>issue.js</code> file is looking at the
<code>../gateway/networkConnection.yaml</code>, we need to modify this file to
represent our connection profile. We can do this by opening the
<code>networkConnection.yaml</code> file in VSCode and then modifying the ports of
our Orderer (line 91), Peer (line 105) and CA (117). You can find these
ports by doing the following command from your terminal application.
<strong>NOTE:</strong> scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ docker ps -a
</code></pre>
<p>Once you have modified the file, please <strong>save it (control + s)</strong>.</p>
<p><img alt="image" src="../images/18.png" /></p>
<p><strong>5.</strong> Enter the following command to install the needed packages
from the <code>package.json</code> file. <strong>NOTE:</strong> scroll over to see the entire
command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ npm install
.
. # A bunch of output, with some of the output repeating
.
node-pre-gyp WARN Using request for node-pre-gyp https download 
[grpc] Success: "/home/tecadmin/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application/node_modules/grpc/src/node/extension_binary/node-v57-darwin-x64-unknown/grpc_node.node" is installed via remote
npm notice created a lockfile as package-lock.json. You should commit this file.
npm WARN nodejs@1.0.0 No description
npm WARN nodejs@1.0.0 No repository field.

added 318 packages in 36.994s
</code></pre>
<p><strong>6.</strong> Since we are in our command line, let's issue the following
command that will create Isabella. <strong>NOTE:</strong> scroll over to see the
entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ node addToWallet.js 
done
</code></pre>
<p><strong>7.</strong> We will know it worked if we can execute the following command
successfully. <strong>NOTE:</strong> scroll over to see the entire command
below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ ls -l ../identity/user/isabella/wallet/
total 0
drwxr-xr-x  5 tecadmin  tecadmin  160 Feb 22 12:53 User1@org1.example.com
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ ls -l ../identity/user/isabella/wallet/User1@org1.example.com/
total 24
-rw-r--r--  1 tecadmin  tecadmin  1037 Feb 22 12:53 User1@org1.example.com
-rw-r--r--  1 tecadmin  tecadmin   246 Feb 22 12:53 c75bd6911aca808941c3557ee7c97e90f3952e379497dc55eb903f31b50abc83-priv
-rw-r--r--  1 tecadmin  tecadmin   182 Feb 22 12:53 c75bd6911aca808941c3557ee7c97e90f3952e379497dc55eb903f31b50abc83-pub
</code></pre>
<p>Keys are vital to understanding how transactions and identity work
within a blockchain network. Below is a break down of the keys and
certificate used in this example</p>
<ul>
<li>a <strong>private key</strong> <code>c75bd6911a...-priv</code> used to sign transactions on
    Isabella's behalf, but not distributed outside of her immediate
    control</li>
<li>a <strong>public key</strong> <code>c75bd6911a...-pub</code> which is cryptographically
    linked to Isabella's private key. This public key is contained within
    Isabella's X.509 certificate</li>
<li>a <strong>certificate</strong> <code>User1@org.example.com</code> which contains Isabella's
    public key and other X.509 attributes added by the Certificate
    Authority at certificate creation. This certificate is distributed
    to the network so that different actors at different times can
    cryptographically verify information signed by Isabella's private
    key</li>
</ul>
<p><strong>8.</strong> Now that we have Isabella from MagnetoCorp, let's perform 
the issue transaction from our terminal. <strong>NOTE:</strong> scroll over to see
the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ node issue.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper issue transaction.
2019-02-22T17:55:20.631Z - info: [TransactionEventHandler]: _strategySuccess: strategy success for transaction "f8e124886d6cb84434cb6a996f4889145c0541199c88bab7d4d85ae41266e51e"
Process issue transaction response.
MagnetoCorp commercial paper : 00001 successfully issued for value 5000000
Transaction complete.
Disconnect from Fabric gateway.
Issue program complete.
</code></pre>
<p>This successfully committed a transaction to the ledger. See how it
outputted a transaction hash for us.</p>
<p>As you can see in the image below, we are using the certificate
belonging to Isabella to submit our paper issue transaction. Once we
verify that Isabella can submit a transaction (via her certificate), the
gateway allows the application to focus on transaction generation,
submission and response. It coordinates the transaction proposal,
ordering and notification processing between the different network
components.</p>
<p><img alt="image" src="../images/papernet_magnetoissue.png" /></p>
<p><strong>9.</strong> Since we have created an identity for MagnetoCorp, let's also
create Balaji from DigiBank. To do so, we will need a third command line
tab. We can add another command line tab by clicking on
<code>File -&gt; New Tab</code>. This will create a new tab in the terminal from the
exact folder directory we were in from our second command line tab. This
third tab will act as DigiBank.</p>
<p><strong>10.</strong> We now need to switch to a new directory, specifically the
application folder of DigiBank. <strong>NOTE:</strong> scroll over to see the entire
command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ cd ../../digibank/application/
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$
</code></pre>
<p><strong>11.</strong> Navigate to the application folder of DigiBank in the
editior perspective in VSCode </p>
<pre><code>fabric-samples -&gt; commercial paper -&gt; organization -&gt; digibank -&gt; application
</code></pre>
<p>You should see 5 files here:
<code>.eslintrc.js, addtowallet.js, buy.js, redeem.js and package.json</code></p>
<p><strong>12.</strong> Go ahead and click on <code>buy.js</code> and scroll through the file. You
will notice on <code>line 40</code> that it is looking at the
<code>../gateway/networkConnection.yaml</code> file.</p>
<p>We need to modify the <code>networkConnection.yaml</code> file to represent our
network - very similar to <code>step 4</code> of this section.</p>
<p><strong>13.</strong> We need to modify the ports of our Orderer (line 91), Peer (line
105) and CA (117). We can find these ports by doing the following
command from our terminal. If you are confused as to where to modify
your port numbers, look at the picture on <code>step 4</code> to get a sense as to
where we are grabbing our ports from. <strong>NOTE:</strong> scroll over to see the
entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ docker ps -a
</code></pre>
<p>Once we have modified the file, please <strong>save it (control + s).</strong>
<strong>NOTE:</strong> If you don't do this step, the rest of the lab will not work.</p>
<p><strong>14.</strong> Back in our terminal and using our <code>DigiBank</code> tab, we can run
the next command to install some required packages. <strong>NOTE:</strong> You will
have to scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ npm install
.
.
.
node-pre-gyp WARN Using request for node-pre-gyp https download 
[grpc] Success: "/home/tecadmin/Desktop/fabric-samples/commercial-paper/organization/digibank/application/node_modules/grpc/src/node/extension_binary/node-v57-darwin-x64-unknown/grpc_node.node" is installed via remote
npm notice created a lockfile as package-lock.json. You should commit this file.
npm WARN nodejs@1.0.0 No description
npm WARN nodejs@1.0.0 No repository field.

added 318 packages in 27.138s
</code></pre>
<p><strong>15.</strong> Now, let's add Balaji from <code>DigiBank</code>. <strong>NOTE:</strong> scroll over
to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node addToWallet.js 
done
</code></pre>
<p><strong>16.</strong> We can confirm that we actually created an identity by viewing
its public/private key below. <strong>NOTE:</strong> scroll over to see the entire
command </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ ls -l ../identity/user/balaji/wallet/
total 0
drwxr-xr-x  5 tecadmin  tecadmin  160 Feb 22 12:57 Admin@org1.example.com
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ ls -l ../identity/user/balaji/wallet/Admin@org1.example.com/
total 24
-rw-r--r--  1 tecadmin  tecadmin  1033 Feb 22 12:57 Admin@org1.example.com
-rw-r--r--  1 tecadmin  tecadmin   246 Feb 22 12:57 cd96d5260ad4757551ed4a5a991e62130f8008a0bf996e4e4b84cd097a747fec-priv
-rw-r--r--  1 tecadmin  tecadmin   182 Feb 22 12:57 cd96d5260ad4757551ed4a5a991e62130f8008a0bf996e4e4b84cd097a747fec-pub
</code></pre>
<p>In the next section, we will actually upgrade our smart contract before
submitting transactions. We are upgrading our smart contract in order to add in a query to get the status of our paper.</p>
<p>Based on the picture below, we now have 2 participants in this network.
Obviously, this is MagnetoCorp (Isabella) and DigiBank (Balaji). Both
participants are allowed to interact with the commercial paper
blockchain network through their application.</p>
<p><img alt="image" src="../images/papernet_magnetodigi.png" /></p>
<h2 id="section-5-upgrade-smart-contract">Section 5: Upgrade Smart Contract</h2>
<p><strong>1.</strong> From our Explorer perspective, navigate to the contract/lib
folder of <code>DigiBank</code> </p>
<pre><code>fabric-samples -&gt; commercial-paper -&gt; organization -&gt; digibank -&gt; contract -&gt; lib
</code></pre>
<p><strong>2.</strong> Within the <code>papercontract.js</code> file, scroll down to line number
<code>54</code> and enter the following lines of code below </p>
<pre><code>/**
* Get commercial paper
* @param {Context} ctx the transaction context
* @param {String} issuer commercial paper issuer
* @param {Integer} paperNumber paper number for this issuer
*/
async getPaper(ctx, issuer, paperNumber) {
  try {
    console.log("getPaper for: " + issuer + " " + paperNumber);
    let paperKey = CommercialPaper.makeKey([issuer, paperNumber]);
    let paper = await ctx.paperList.getPaper(paperKey);
    return paper.toBuffer();
  } catch(e) {
    throw new Error('Paper does not exist' + issuer + paperNumber);
  }
}
</code></pre>
<p><strong>3.</strong> From the terminal in our <code>digibank tab</code>, add a file below that
will execute the query that we just added to our smart contract. <strong>NOTE:</strong>
there are multiple steps in this command and you will have to scroll over to see the entire series of commands below</p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ touch getPaper.js
tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ vi getPaper.js

---

type the letter "i" to go into insert mode and paste in the following lines of code below

---

/*
SPDX-License-Identifier: Apache-2.0
*/

/*
* This application has 6 basic steps:
* 1. Select an identity from a wallet
* 2. Connect to network gateway
* 3. Access PaperNet network
* 4. Construct request to issue commercial paper
* 5. Submit transaction
* 6. Process response
*/

'use strict';

// Bring key classes into scope, most importantly Fabric SDK network class
const fs = require('fs');
const yaml = require('js-yaml');
const { FileSystemWallet, Gateway } = require('fabric-network');
const CommercialPaper = require('../contract/lib/paper.js');

// A wallet stores a collection of identities for use 
//const wallet = new FileSystemWallet('../../../connection-local-fabric');
const wallet = new FileSystemWallet('../identity/user/balaji/wallet');

// Main program function
async function main() {

  // A gateway defines the peers used to access Fabric networks
  const gateway = new Gateway();

  // Main try/catch block
  try {

    // Specify userName for network access
    // const userName = 'isabella.issuer@magnetocorp.com';
    const userName = 'Admin@org1.example.com';

    // Load connection profile; will be used to locate a gateway 
    let connectionProfile = yaml.safeLoad(fs.readFileSync('../gateway/networkConnection.yaml', 'utf8'));

    // Set connection options; identity and wallet
    let connectionOptions = {
      identity: userName,
      wallet: wallet,
      discovery: { enabled: false, asLocalhost: true }
    };

    // Connect to gateway using application specified parameters
    console.log('Connect to Fabric gateway.');

    await gateway.connect(connectionProfile, connectionOptions);

    // Access PaperNet network
    console.log('Use network channel: mychannel.');

    const network = await gateway.getNetwork('mychannel');

    // Get addressability to commercial paper contract
    console.log('Use org.papernet.commercialpaper smart contract.');

    const contract = await network.getContract('papercontract', 'org.papernet.commercialpaper');

    // get commercial paper
    console.log('Submit commercial paper getPaper transaction.');

    const getPaperResponse = await contract.evaluateTransaction('getPaper', 'MagnetoCorp', '00001');

    // process response
    console.log('Process getPaper transaction response.');

    let paper = CommercialPaper.fromBuffer(getPaperResponse);
    let paperState = "Unknown";
    if (paper.isIssued()) {
      paperState = "ISSUED";
    } else if (paper.isTrading()) {
      paperState = "TRADING";
    } else if (paper.isRedeemed()) {
      paperState = "REDEEMED";
    }

    console.log(` +--------- Paper Retrieved ---------+ `);
    console.log(` | Paper number: "${paper.paperNumber}"`);
    console.log(` | Paper is owned by: "${paper.owner}"`);
    console.log(` | Paper is currently: "${paperState}"`);
    console.log(` | Paper face value: "${paper.faceValue}"`);
    console.log(` | Paper is issued by: "${paper.issuer}"`);
    console.log(` | Paper issue on: "${paper.issueDateTime}"`);
    console.log(` | Paper matures on: "${paper.maturityDateTime}"`);
    console.log(` +-----------------------------------+ `);
    console.log('Transaction complete.');

  } catch (error) {

    console.log(`Error processing transaction. ${error}`);
    console.log(error.stack);

  } finally {

    // Disconnect from the gateway
    console.log('Disconnect from Fabric gateway.')
    gateway.disconnect();

  }
}
main().then(() =&gt; {

  console.log('getPaper program complete.');

}).catch((e) =&gt; {

  console.log('getPaper program exception.');
  console.log(e);
  console.log(e.stack);
  process.exit(-1);

});

---

To get out of vi, hit the "ESC" button. Then type in ":wq" and then press enter to save the file
</code></pre>
<p>Who knew you would learn <code>vi</code> in a VSCode lab! Send your hate mail to
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#117;&#115;&#116;&#105;&#110;&#64;&#100;&#111;&#110;&#116;&#115;&#101;&#110;&#100;&#104;&#97;&#116;&#101;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#97;&#117;&#115;&#116;&#105;&#110;&#64;&#100;&#111;&#110;&#116;&#115;&#101;&#110;&#100;&#104;&#97;&#116;&#101;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a> :)</p>
<p><strong>4.</strong> We now have a new file (<code>getPaper.js</code>) that calls the getPaper transactionj
that we have added to our
<code>papercontract.js</code> smart contract. This doesn't mean we can execute a
getPaper query quite yet because, if you remember, we have to install and
instantiate this update onto our peer. Then - and only then - can we
actually submit the getPaper query. The next few steps will walk us
through how to do that.</p>
<p>It would be helpful to understand what we just added to our
soon-to-be-updated smart contract. The <code>getPaper</code> query is being
submitted by <code>Balaji</code> from <code>DigiBank</code> and it allows him to get the
current status of the paper within the network. For example, it prints
out the paper's identification number, the paper's cost, the paper's state
(trading, redeemed, issued), the paper's issue date and a few other key
details. Read on for a further breakdown of the query.</p>
<p>Below, this statement brings two key Hyperledger Fabric SDK classes into
scope -- Wallet and Gateway. Because <code>Balaji’s</code> X.509 certificate is in
the local file system, the application uses FileSystemWallet </p>
<pre><code>// Bring key classes into scope, most importantly Fabric SDK network class 
const { FileSystemWallet, Gateway } = require('fabric-network');
</code></pre>
<p>Below, this statement identifies that the application will use
<code>Balaji's</code> wallet when it connects to the blockchain network channel.
The application will select a particular identity within <code>Balaji's</code>
wallet. (The wallet must have been loaded with Balaji's X.509
certificate -- that's what addToWallet.js does.) </p>
<pre><code>// A wallet stores a collection of identities for use 
const wallet = new FileSystemWallet('../identity/user/balaji/wallet');
</code></pre>
<p>Below, this line of code connects to the network using the gateway
identified by connectionProfile, using the identity referred to in
connectionOptions. See how ../gateway/networkConnection.yaml and
<code>Admin@org1.example.com</code> are used for these values respectively </p>
<pre><code>// Connect to gateway using application specified parameters 
await gateway.connect(connectionProfile, connectionOptions);
</code></pre>
<p>Below, this connects the application to the network channel mychannel,
where the papercontract was previously instantiated. If you had a
different channel name, you would have to modify this line of code </p>
<pre><code>// Access commercial paper network 
const network = await gateway.getNetwork('mychannel');
</code></pre>
<p>Below, this statement gives the application addressability to the smart
contract defined by the namespace org.papernet.commercialpaper within
papercontract. Once an application has issued getContract, it can submit
any transaction/query implemented within it</p>
<pre><code>// Get addressability to commercial paper contract 
const contract = await network.getContract('papercontract','org.papernet.commercialpaper');
</code></pre>
<p>This series of log output is what the query prints out for us. Based on
the defined variables in the <code>papercontract.js</code> we are able to query for
pretty specific bits of data to get an overview of our paper. You can
look above and see how we are grabbing our <code>paperState</code></p>
<pre><code>console.log(` +--------- Paper Retrieved ---------+ `);
console.log(` | Paper number: "${paper.paperNumber}"`);
console.log(` | Paper is owned by: "${paper.owner}"`);
console.log(` | Paper is currently: "${paperState}"`);
console.log(` | Paper face value: "${paper.faceValue}"`);
console.log(` | Paper is issued by: "${paper.issuer}"`);
console.log(` | Paper issue on: "${paper.issueDateTime}"`);
console.log(` | Paper matures on: "${paper.maturityDateTime}"`);
console.log(` +-----------------------------------+ `);
console.log('Transaction complete.');
</code></pre>
<p>Below, this part of the code looks at the
<code>let paper = CommercialPaper.fromBuffer(getPaperResponse);</code> message and
then defines what the current status of the paper is. There are 4
options, <code>UNKNOWN, ISSUED, TRADING, and REDEEMED</code> </p>
<pre><code>let paper = CommercialPaper.fromBuffer(getPaperResponse);
let paperState = "Unknown";
    if (paper.isIssued()) {
paperState = "ISSUED";
    } else if (paper.isTrading()) {
paperState = "TRADING";
    } else if (paper.isRedeemed()) {
paperState = "REDEEMED";
    }
</code></pre>
<p>Below, this chunk of code simply disconnects from the gateway.
No matter if our query was successful or if there
was an error, we'll be disconnected from the gateway </p>
<pre><code>// Disconnect from the gateway
console.log('Disconnect from Fabric gateway.')
gateway.disconnect();
</code></pre>
<p><strong>5.</strong> In order to upgrade our smart contract, we need to add a fabric
gateway using our IBM Blockchain extension. To do that, switch back to the
IBM Blockchain extension within VSCode and click on the gear icon in the
bottom left. Then, click on <code>Command Palette</code></p>
<p><img alt="image" src="../images/19.png" /></p>
<p><strong>6</strong> To add a Fabric Gateway, type this, below, in the search bar of our list
of commands to execute </p>
<pre><code>&gt;IBM Blockchain Platform: Add Gateway
</code></pre>
<p>Fabric gateways are ways for us to connect to a blockchain network from
the perspective of a particular user. In this case, we are acting as <code>Balaji</code> from <code>DigiBank</code>
in this commercial paper network. If there were more actors, you could
envision more gateways being incorportated here</p>
<p><strong>7.</strong> For the name of the gateway, enter <code>papercontract</code></p>
<p><img alt="image" src="../images/20.png" /></p>
<p><strong>8.</strong> When it asks for a <code>file path to a connection profile</code>, select
<code>Browse</code></p>
<p><strong>9.</strong> Then navigate to the <code>networkConnection.yaml</code> file within
<code>Digibank</code> to grab the connection profile</p>
<p><img alt="image" src="../images/21.png" /></p>
<p><strong>10.</strong> It will then ask us if we would like to use an existing wallet
or create a new wallet. We want to choose
<code>Use an existing wallet on my file system</code></p>
<p><strong>11.</strong> When it asks for a <code>file path to a wallet directory</code>, select
<code>Browse</code></p>
<p><strong>12.</strong> Then, we will navigate to the wallet of <code>Balaji</code>, our user. Click
on <code>Select</code> once you have clicked and highlighted on <code>wallet</code></p>
<p><img alt="image" src="../images/22.png" /></p>
<p><strong>13.</strong> We will then see a new Fabric Gateway within the IBM Blockchain
extension as well as <code>successful</code> messages from the output</p>
<p><img alt="image" src="../images/23.png" /></p>
<p><strong>14.</strong> We can then click on <code>Admin@org1.example.com</code> and then it will
show all of our channels. Furthermore, it will show all the smart
contracts available on the channel. You'll see we have
<code>mycontract@0.0.1</code> and <code>papercontract@0</code>. Even further, we can see all
the available transactions/queries based on the smart contract. All of
these are available if we untoggle the channels and smart contracts.</p>
<p>Even though we have added the new fabric gateway, we still haven't
updated our smart contract to include the <code>getPaper</code> query. We will do
that in the next series of commands.</p>
<p><strong>15.</strong> Switch back to the <code>Explorer</code> perspective and toggle the
<code>fabric-samples</code> to hide all of the folders and files. Then click on
<code>File</code> and select <code>Add Folder to Workplace</code> to add a new folder to the
workspace</p>
<p><strong>16.</strong> Once it gives us a pop-up of the folder directory, navigate to
the <code>contract</code> folder of <code>Digibank</code>. Click on or highlight the
<code>contract</code> folder </p>
<pre><code>fabric-samples -&gt; commercial-paper -&gt; organization -&gt; digibank -&gt; contract
</code></pre>
<p><img alt="image" src="../images/24.png" /></p>
<p><strong>17.</strong> Here we will name the smart contract <code>papercontract</code> and give it
version <code>0.0.2</code>. First, untoggle the <code>contract</code> folder and click on the
<code>package.json</code> file to open it. Within that file, change lines 2 and 3
to look like this below </p>
<pre><code>"name": "papercontract",
"version": "0.0.2",
</code></pre>
<p><img alt="image" src="../images/25.png" /></p>
<p><strong>18.</strong> Switch back to the IBM Blockchain extension. From there click on
the gear in the bottom left and select <code>Command Palette</code>. When the
search bar of available commands appears, type in the following below </p>
<pre><code>&gt;IBM Blockchain Platform: Package a Smart Contract Project
</code></pre>
<p><img alt="image" src="../images/26.png" /></p>
<p><strong>22.</strong> When it asks for a <code>workplace folder to package</code> choose
<code>contract</code>. Then it will pull in the folder and name it
<code>papercontract@0.0.2</code> based on our modifications to the <code>package.json</code>
file</p>
<p><strong>23.</strong> Now that we have our packaged smart contract, let's upgrade our
current smart contract. To do so, within the <code>Local Fabric Ops</code> pane,
untoggle the <code>Channels</code> and right click on <code>mychannel</code>. Then select
<code>Upgrade Smart Contract</code></p>
<p><img alt="image" src="../images/27.png" /></p>
<p><strong>24.</strong> It will then ask which current smart contract we want to
upgrade. We want to select <code>papercontract@0</code> to upgrade. Then it will
ask which <code>smart contract version to preform an upgrade with</code>, we want
to select <code>papercontract@0.0.2</code>. Since we have to install our upgraded
contract on a peer, select <code>peer0.org1.example.com</code> to install the smart
contract on. When it asks for any arguments, do not enter anything here,
but simply press enter to execute our upgrade. You will know
this was successful if we click on <code>Admin@org1.example.com</code> under the
<code>papercontract</code> gateway. Then untoggle the <code>papercontract@0.0.2</code>
smart contract to see all the available transactions and queries.</p>
<p><img alt="image" src="../images/28.png" /></p>
<p>We have successfully upgraded our smart contract to include the
<code>getPaper</code> query. Now let's have some fun and make some transactions and
queries!</p>
<h2 id="section-6-submit-transactions">Section 6: Submit Transactions</h2>
<p><strong>1.</strong> If you remember, we already did an issue transaction back before
upgrading our smart contract. Since we have added the <code>getPaper</code> query
to our smart contract, let's do that from the <code>digibank</code> perspective
using <code>getPaper.js</code>. As you already know, the <code>getPaper</code> query will get
the current status of the paper on top of other bits of information,
like price.</p>
<p><strong>2.</strong> From the <code>digibank</code> perspective in your terminal (your 3rd
terminal) enter this command. <strong>NOTE:</strong> scroll over to see the entire
command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node getPaper.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper getPaper transaction.
Process getPaper transaction response.
 +--------- Paper Retrieved ---------+ 
 | Paper number: "00001"
 | Paper is owned by: "MagnetoCorp"
 | Paper is currently: "ISSUED"
 | Paper face value: "5000000"
 | Paper is issued by: "MagnetoCorp"
 | Paper issue on: "2020-05-31"
 | Paper matures on: "2020-11-30"
 +-----------------------------------+ 
Transaction complete.
Disconnect from Fabric gateway.
getPaper program complete.
</code></pre>
<p><strong>3.</strong> Now that we know the status of our paper, let's actually buy the
paper. <strong>NOTE:</strong> scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node buy.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper buy transaction.
2019-02-28T19:52:17.372Z - info: [TransactionEventHandler]: _strategySuccess: strategy success for transaction "871e7743c58e406575d4e553330faae3711c0a65a2f677b6e6d398650069d81a"
Process buy transaction response.
MagnetoCorp commercial paper : 00001 successfully purchased by DigiBank
Transaction complete.
Disconnect from Fabric gateway.
Buy program complete.
</code></pre>
<p><strong>4.</strong> Let's observe the current status of the paper. <strong>NOTE:</strong> scroll
over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node getPaper.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper getPaper transaction.
Process getPaper transaction response.
+--------- Paper Retrieved ---------+ 
 | Paper number: "00001"
 | Paper is owned by: "DigiBank"
 | Paper is currently: "TRADING"
 | Paper face value: "5000000"
 | Paper is issued by: "MagnetoCorp"
 | Paper issue on: "2020-05-31"
 | Paper matures on: "2020-11-30"
 +-----------------------------------+ 
Transaction complete.
Disconnect from Fabric gateway.
getPaper program complete.
</code></pre>
<p><strong>5.</strong> Let's pretend the maturity date has been reached so that we can now
redeem this paper. Let's do that now. <strong>NOTE:</strong> scroll over to see the
entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node redeem.js 
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper redeem transaction.
2019-02-28T19:52:46.452Z - info: [TransactionEventHandler]: _strategySuccess: strategy success for transaction "c26ecbf1077d99a5ea025c339ffabd88eb22cf4e6ac5ff8d9b570cd6c38eb531"
Process redeem transaction response.
MagnetoCorp commercial paper : 00001 successfully redeemed with MagnetoCorp
Transaction complete.
Disconnect from Fabric gateway.
Redeem program complete.
</code></pre>
<p><strong>6.</strong> Once again, let's get the status of the paper. <strong>NOTE:</strong> scroll
over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node getPaper.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper getPaper transaction.
Process getPaper transaction response.
 +--------- Paper Retrieved ---------+ 
 | Paper number: "00001"
 | Paper is owned by: "MagnetoCorp"
 | Paper is currently: "REDEEMED"
 | Paper face value: "5000000"
 | Paper is issued by: "MagnetoCorp"
 | Paper issue on: "2020-05-31"
 | Paper matures on: "2020-11-30"
 +-----------------------------------+ 
Transaction complete.
Disconnect from Fabric gateway.
getPaper program complete.
</code></pre>
<p><strong>7.</strong> We have successfully run a few transactions and queries with 1
paper and all from our terminal. Now, let's make a 2nd paper and mix up
the method of how we do the transactions and queries. To do this, go
back to VSCode and into the <code>Explorer</code> perspective. From there, navigate
to the <code>issue.js</code> file within MagnetoCorp </p>
<pre><code>fabric-samples -&gt; commercial-paper -&gt; organization -&gt; magnetocorp -&gt; application -&gt; issue.js
</code></pre>
<p><strong>8.</strong> On what should be line <code>68</code>, change the issue transaction code to
what is below. <strong>NOTE:</strong> scroll over to see the line of code change
below </p>
<pre><code>Take this..

const issueResponse = await contract.submitTransaction('issue', 'MagnetoCorp', '00001', '2020-05-31', '2020-11-30', '5000000');

..and change to

const issueResponse = await contract.submitTransaction('issue', 'MagnetoCorp', '00002', '2019-06-31', '2019-12-30', '6000000');
</code></pre>
<p>That line of code is creating a new paper. Go ahead and <strong>save this file
(control + s)</strong>.</p>
<p><strong>9.</strong> Now navigate to the <code>getPaper.js</code> file within <code>digibank</code> and
change the key below to look for a paper with an id of <code>00002</code> on line
<code>68</code> </p>
<pre><code>fabric-samples -&gt; commercial-paper -&gt; organization -&gt; digibank -&gt; application -&gt; getPaper.js

---

Take this..

const getPaperResponse = await contract.evaluateTransaction('getPaper', 'MagnetoCorp', '00001');

.. and change to

const getPaperResponse = await contract.evaluateTransaction('getPaper', 'MagnetoCorp', '00002');
</code></pre>
<p>That line of code is changing the <code>getPaper.js</code> file to look for the
paper with an ID of <code>00002</code>. Go ahead and <strong>save this file (control +
s)</strong>.</p>
<p><strong>10.</strong> Now that we have modified our code, let's go ahead and issue a
new paper from our terminal. To do this, we have to be in our
<code>MagnetoCorp</code> perspective (our 2nd terminal tab). Within that command
line, enter this. <strong>NOTE:</strong> scroll over to see the entire command below</p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/magnetocorp/application$ node issue.js 
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper issue transaction.
2019-02-28T19:54:09.436Z - info: [TransactionEventHandler]: _strategySuccess: strategy success for transaction "bec2e62e6c440d214cd61336fd3b38a1024e590afa58c5f90421e6db19cc410c"
Process issue transaction response.
MagnetoCorp commercial paper : 00002 successfully issued for value 6000000
Transaction complete.
Disconnect from Fabric gateway.
Issue program complete.
</code></pre>
<p><strong>11.</strong> Now, switch to <code>Digibank's</code> perspective in our terminal (our 3rd
terminal tab) and do a <code>getPaper</code> query using <code>getPaper.js</code>. <strong>NOTE:</strong>
scroll over to see the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node getPaper.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper getPaper transaction.
Process getPaper transaction response.
 +--------- Paper Retrieved ---------+ 
 | Paper number: "00002"
 | Paper is owned by: "MagnetoCorp"
 | Paper is currently: "ISSUED"
 | Paper face value: "6000000"
 | Paper is issued by: "MagnetoCorp"
 | Paper issue on: "2019-06-31"
 | Paper matures on: "2019-12-30"
 +-----------------------------------+ 
Transaction complete.
Disconnect from Fabric gateway.
getPaper program complete.
</code></pre>
<p><strong>12.</strong> That's enough command line for right now- let's jump to VSCode
and buy our new paper there. Within the IBM Blockchain extension, go to
the <code>Fabric Gateway</code> and click on the <code>papercontect</code> gateway. From
there, click on <code>Admin@org1.example.com</code> and untoggle to the
transactions and query. Then, right click on the <code>buy</code> transaction and
select <code>Submit Transaction</code></p>
<p><img alt="image" src="../images/29.png" /></p>
<p>When it asks for some arguments to pass in with the buy transaction,
enter this below </p>
<pre><code>MagnetoCorp,00002,MagnetoCorp,DigiBank,5900000,2019-07-31
</code></pre>
<p><strong>13.</strong> We will see that transaction was successful from the output it
generated in VSCode. We can confirm that by doing a <code>getPaper.js</code> query
again in our terminal (3rd terminal tab). <strong>NOTE:</strong> scroll over to see
the entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node getPaper.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper getPaper transaction.
Process getPaper transaction response.
 +--------- Paper Retrieved ---------+ 
 | Paper number: "00002"
 | Paper is owned by: "DigiBank"
 | Paper is currently: "TRADING"
 | Paper face value: "6000000"
 | Paper is issued by: "MagnetoCorp"
 | Paper issue on: "2019-06-31"
 | Paper matures on: "2019-12-30"
 +-----------------------------------+ 
Transaction complete.
Disconnect from Fabric gateway.
getPaper program complete.
</code></pre>
<p><strong>14.</strong> We are going to repeat the previous 2 steps, but this time we
are going to do a redeem transaction from the IBM Blockchain extension.
To do this, go to the <code>Fabric Gateway</code> pane and click on the
<code>papercontract</code> gateway. From there, click on <code>Admin@org1.example.com</code>
and untoggle to the transactions and query. Then, right click on
<code>redeem</code> and select <code>Submit Transaction</code></p>
<p><img alt="image" src="../images/30.png" /></p>
<p>When it asks for some arguments to pass to the transaction, enter this below :</p>
<pre><code>MagnetoCorp,00002,DigiBank,2019-12-30
</code></pre>
<p><strong>15.</strong> What do you think the next action will be? If you're thinking
the <code>getPaper</code> query, you were right. <strong>NOTE:</strong> scroll over to see the
entire command below </p>
<pre><code>tecadmin@ubuntubase:~/Desktop/fabric-samples/commercial-paper/organization/digibank/application$ node getPaper.js
Connect to Fabric gateway.
Use network channel: mychannel.
Use org.papernet.commercialpaper smart contract.
Submit commercial paper getPaper transaction.
Process getPaper transaction response.
 +--------- Paper Retrieved ---------+ 
 | Paper number: "00002"
 | Paper is owned by: "MagnetoCorp"
 | Paper is currently: "REDEEMED"
 | Paper face value: "6000000"
 | Paper is issued by: "MagnetoCorp"
 | Paper issue on: "2019-06-31"
 | Paper matures on: "2019-12-30"
 +-----------------------------------+ 
Transaction complete.
Disconnect from Fabric gateway.
getPaper program complete.
</code></pre>
<p>Feel free to continue to make and trade more papers by submitting
various transactions and queries. If you do not want to make more
papers, please continue to last section, which will simply clean up the
lab environment.</p>
<h2 id="section-7-lab-cleanup">Section 7: Lab Cleanup</h2>
<p><strong>1.</strong> To clean up the lab environment, please enter this in your
terminal below </p>
<pre><code>docker stop $(docker ps -q) # to stop all of your running docker containers
docker rm $(docker ps -aq) # to remove all of your docker containers
docker rmi -f $(docker images -q) # to remove all of your docker images
</code></pre>
<p><strong>2.</strong> Finally, go back to your <code>Explorer</code> perspective and right click
on each of your folders and select <code>Remove Folder from Workplace</code> for each one. This
will get rid of all of your folders from your Explorer perspective, but don't worry
as those folders are not deleted from your file system!</p>
<p><strong>END OF LAB!</strong></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../connect-home/" class="btn btn-neutral float-right" title="Introduction">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../vscode-part1/" class="btn btn-neutral" title="Part 1"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/ibm-blockchain-wsc/ImmersionWorkshop.git" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../vscode-part1/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../connect-home/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
